<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meteo personnelle</title>
  <style>
    :root{
      --bg:#0b0f14; --fg:#e6e8eb; --muted:#9aa4af; --card:#121821; --accent:#4ea1ff;
      --blue:#3b82f6; --yellow:#facc15; --orange:#fb923c; --shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    [data-theme="light"]{ --bg:#f6f7f9; --fg:#0e1116; --muted:#586173; --card:#ffffff; --accent:#0b74ff; --shadow: 0 8px 20px rgba(0,0,0,.08);}    
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, "Helvetica Neue", Arial}
    a{color:var(--accent);text-decoration:none}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px}
    .title{font-size:22px;font-weight:700;letter-spacing:.2px}
    .subtitle{font-size:13px;color:var(--muted)}
    .row{display:grid;grid-template-columns:1.5fr 1fr;gap:16px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:16px;box-shadow:var(--shadow);position:relative;overflow:hidden}

    /* --- Background image layer (only for #currentCard) --- */
    #currentCard.bg-img::before{
      content:"";
      position:absolute;
      inset:0;
      background-image: var(--bg-image, none);
      background-size:cover;
      background-position:center;
      z-index:0;
      transform:scale(1.5);
      animation:zoomOut 5s ease forwards;
      transform-origin:center;
      will-change:transform;
    }
    #currentCard.bg-img::after{
      content:"";
      position:absolute;
      inset:0;
      background:linear-gradient(to bottom, rgba(0,0,0,0.35), rgba(0,0,0,0.55));
      z-index:1;
    }
    #currentCard > *{position:relative;z-index:2}

    .controls{display:flex;gap:10px;flex-wrap:wrap}
    button,.btn{background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--fg);padding:8px 12px;border-radius:12px;cursor:pointer}
    button:hover,.btn:hover{border-color:var(--accent)}
    .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    @media (max-width:700px){.grid{grid-template-columns:repeat(2,1fr)}}
    .current{display:grid;grid-template-columns:auto 1fr;gap:14px;align-items:center}
    .current .temp{font-size:48px;font-weight:800}
    .kpi{display:flex;gap:14px;flex-wrap:wrap;margin-top:6px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.8);color:#222;font-size:13px}
    .scrollx{display:flex;gap:10px;overflow:auto;padding-bottom:6px}
    .hour{min-width:84px;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.1);text-align:center;background:rgba(0,0,0,.08)}
    .muted{color:var(--muted)}
    .temp-blue{color:var(--blue)} .temp-yellow{color:var(--yellow)} .temp-orange{color:var(--orange)}
    .footer{margin-top:18px;font-size:12px;color:var(--muted)}

    @keyframes zoomOut {
      0% {transform:scale(1.2);}
      100% {transform:scale(1);}
    }
  </style>
</head>
<body data-theme="dark">
  <div class="wrap">
    <header>
      <div>
        <div class="title">Meteo personnelle</div>
        <div class="subtitle" id="locationLabel">Luxembourg • en cours de chargement...</div>
      </div>
      <div class="controls">
        <button id="themeBtn" title="Basculer clair/sombre">Theme</button>
        <button id="gpsBtn" title="Utiliser la geolocalisation">GPS</button>
        <button id="refreshBtn" title="Rafraichir">Refresh</button>
        <button id="apiBtn" title="Changer la cle API">Cle API</button>
      </div>
    </header>

    <div class="row">
      <section class="card bg-img" id="currentCard">
        <div class="current">
          <img id="currentIcon" alt="icon" width="84" height="84" src="" />
          <div>
            <div class="temp" id="currentTemp">--°C</div>
            <div class="muted" id="currentDesc">--</div>
            <div class="kpi">
              <span class="pill" id="feelsLike">Ressenti --°C</span>
              <span class="pill" id="wind">Vent -- km/h</span>
              <span class="pill" id="humidity">Humidite --%</span>
              <span class="pill" id="uv">UV --</span>
            </div>
          </div>
        </div>
        <div class="footer" id="updatedAt">Maj --:--</div>
      </section>

      <section class="card">
        <h3 style="margin:0 0 10px 0">Previsions 5 jours</h3>
        <div class="grid" id="dailyGrid"></div>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <h3 style="margin:0 0 10px 0">Heure par heure (prochaines 12h)</h3>
      <div class="scrollx" id="hourlyStrip"></div>
    </section>

    <div class="footer">Donnees: OpenWeatherMap • Photos: Unsplash • Page statique.</div>
  </div>

  <script>
    // ---------- CONFIG ----------
    const DEFAULT_COORDS = { lat: 49.6116, lon: 6.1319, label: "Luxembourg" };
    const UNITS = "metric";
    const LANG = "fr";

    // ---------- UTILS ----------
    const $ = sel => document.querySelector(sel);
    const $$ = sel => document.querySelectorAll(sel);
    const fmtTime = ts => new Date(ts * 1000).toLocaleTimeString(undefined, {hour: '2-digit', minute: '2-digit'});
    const fmtDay = ts => new Date(ts * 1000).toLocaleDateString(undefined, { weekday: 'short'});
    const fmtDateNow = () => new Date().toLocaleTimeString(undefined, {hour: '2-digit', minute: '2-digit'});
    const stripDiacritics = s => (s||"").normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    function tempClass(t){ if (t < 10) return 'temp-blue'; if (t < 25) return 'temp-yellow'; return 'temp-orange'; }
    function kmh(ms){ return Math.round(ms * 3.6); }

    // ---------- THEME ----------
    const themeBtn = $('#themeBtn');
    function applyTheme(t){ document.body.setAttribute('data-theme', t); localStorage.setItem('theme', t); }
    themeBtn.addEventListener('click', ()=>{ const t = document.body.getAttribute('data-theme')==='dark'?'light':'dark'; applyTheme(t); });
    applyTheme(localStorage.getItem('theme')||'dark');

    // ---------- API KEY STORAGE ----------
    let apiKey = null;
    function askKey(){
      const k = prompt("Entrez votre clé API OpenWeatherMap:");
      if(k){ localStorage.setItem('owm_api_key', k.trim()); return k.trim(); }
      return null;
    }
    function ensureKey(){
      apiKey = localStorage.getItem('owm_api_key');
      if(!apiKey){ apiKey = askKey(); }
      if(!apiKey){ $('#locationLabel').textContent = 'Clé API manquante.'; }
      return !!apiKey;
    }
    $('#apiBtn').addEventListener('click', ()=>{ askKey(); location.reload(); });

    // ---------- FETCH (free endpoints) ----------
    async function getCurrent(lat, lon){
      const url = new URL('https://api.openweathermap.org/data/2.5/weather');
      url.searchParams.set('lat', lat);
      url.searchParams.set('lon', lon);
      url.searchParams.set('units', UNITS);
      url.searchParams.set('lang', LANG);
      url.searchParams.set('appid', apiKey);
      const r = await fetch(url);
      const j = await r.json();
      if(!r.ok) throw new Error(j?.message || ('HTTP '+r.status));
      return j;
    }
    async function getForecast(lat, lon){
      const url = new URL('https://api.openweathermap.org/data/2.5/forecast');
      url.searchParams.set('lat', lat);
      url.searchParams.set('lon', lon);
      url.searchParams.set('units', UNITS);
      url.searchParams.set('lang', LANG);
      url.searchParams.set('appid', apiKey);
      const r = await fetch(url);
      const j = await r.json();
      if(!r.ok) throw new Error(j?.message || ('HTTP '+r.status));
      return j;
    }

    // ---------- ICONS & BACKGROUNDS ----------
    function iconUrl(code){ return `https://openweathermap.org/img/wn/${code}@2x.png`; }
    function backgroundForIcon(code){
      const c = (code||'').toLowerCase();
      if(c.startsWith('01d')) return 'url(https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=1600&auto=format&fit=crop)';
      if(c.startsWith('01n')) return 'url(https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1600&auto=format&fit=crop)';
      if(c.startsWith('02d')) return 'url(https://images.unsplash.com/photo-1504384308090-c894fdcc538d?q=80&w=1600&auto=format&fit=crop)';
      if(c.startsWith('02n')) return 'url(https://images.unsplash.com/photo-1503264116251-35a269479413?q=80&w=1600&auto=format&fit=crop)';
      if(c.startsWith('03') || c.startsWith('04')) return 'url(https://images.unsplash.com/photo-1499346030926-9a72daac6c63?q=80&w=1600&auto=format&fit=crop)';
      if(c.startsWith('09') || c.startsWith('10')) return 'url(https://images.unsplash.com/photo-1501594907352-04cda38ebc29?q=80&w=1600&auto=format&fit=crop)';
      if(c.startsWith('11')) return 'url(https://images.unsplash.com/photo-1504384308090-c894fdcc538d?q=80&w=1600&auto=format&fit=crop)';
      if(c.startsWith('13')) return 'url(https://images.unsplash.com/photo-1608889177305-94589f5f6b4e?q=80&w=1600&auto=format&fit=crop)';
      if(c.startsWith('50')) return 'url(https://images.unsplash.com/photo-1502082553048-f009c37129b9?q=80&w=1600&auto=format&fit=crop)';
      return 'url(https://images.unsplash.com/photo-1506744038136-46273834b3fb?q=80&w=1600&auto=format&fit=crop)';
    }
    function applyCurrentBackground(iconCode){
      const card = $('#currentCard');
      card.classList.add('bg-img');
      // reset animation by toggling the class
      card.style.setProperty('--bg-image', backgroundForIcon(iconCode));
      card.classList.remove('anim-restart');
      void card.offsetWidth; // reflow to restart animation
      card.classList.add('anim-restart');
    }

    // ---------- RENDER ----------
    function renderCurrent(current){
      const t = Math.round(current.main.temp);
      const desc = stripDiacritics(current.weather?.[0]?.description || '--');
      const icon = current.weather?.[0]?.icon || '01d';
      $('#currentIcon').src = iconUrl(icon);
      $('#currentTemp').textContent = t + '°C';
      $('#currentTemp').className = 'temp ' + tempClass(t);
      $('#currentDesc').textContent = desc;
      $('#feelsLike').textContent = 'Ressenti ' + Math.round(current.main.feels_like) + '°C';
      $('#wind').textContent = 'Vent ' + kmh(current.wind?.speed||0) + ' km/h';
      $('#humidity').textContent = 'Humidite ' + (current.main.humidity ?? '--') + '%';
      $('#uv').textContent = 'UV --'; // pas dispo via /weather
      $('#updatedAt').textContent = 'Maj ' + fmtDateNow();
      applyCurrentBackground(icon);
    }

    function renderHourly(forecast){
      const wrap = $('#hourlyStrip');
      wrap.innerHTML = '';
      // 12 prochaines heures = 4 segments de 3h
      forecast.list.slice(0,4).forEach(item=>{
        const t = Math.round(item.main.temp);
        const el = document.createElement('div');
        el.className = 'hour';
        el.innerHTML = `
          <div class="muted">${new Date(item.dt*1000).toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'})}</div>
          <img src="${iconUrl(item.weather?.[0]?.icon||'01d')}" alt="" width="48" height="48" />
          <div class="${tempClass(t)}" style="font-weight:700">${t}°C</div>
        `;
        wrap.appendChild(el);
      });
    }

    function renderDaily(forecast){
      const byDay = {};
      forecast.list.forEach(it=>{
        const d = new Date(it.dt*1000);
        const key = d.toISOString().slice(0,10); // YYYY-MM-DD
        byDay[key] ||= [];
        byDay[key].push(it);
      });
      // Prendre les 5 prochains jours (en ignorant aujourd'hui si incomplet)
      const days = Object.keys(byDay).sort().slice(0,5);
      const grid = $('#dailyGrid'); grid.innerHTML='';
      days.forEach(key=>{
        const arr = byDay[key];
        const tmin = Math.round(Math.min(...arr.map(a=>a.main.temp_min)));
        const tmax = Math.round(Math.max(...arr.map(a=>a.main.temp_max)));
        // choisir une icone vers midi si possible
        let mid = arr.reduce((best,a)=>{
          const h = new Date(a.dt*1000).getHours();
          const score = Math.abs(12-h);
          return (best==null || score < best.score) ? {icon:a.weather?.[0]?.icon||'01d', score} : best;
        }, null);
        const icon = mid?.icon || '01d';
        const dtAny = new Date(arr[0].dt*1000);
        const dayLabel = dtAny.toLocaleDateString(undefined,{weekday:'short'});
        const el = document.createElement('div');
        el.className = 'hour';
        el.innerHTML = `
          <div class="muted" style="text-transform:capitalize">${stripDiacritics(dayLabel)}</div>
          <img src="${iconUrl(icon)}" alt="" width="48" height="48" />
          <div style="display:flex;justify-content:center;gap:6px">
            <span class="${tempClass(tmax)}" style="font-weight:700">${tmax}°</span>
            <span class="muted">${tmin}°</span>
          </div>
        `;
        grid.appendChild(el);
      });
    }

    function setLocationLabel(name){ $('#locationLabel').textContent = name; }

    async function load(coords){
      setLocationLabel((coords.label||'Localisation') + ' • chargement...');
      const [cur, fc] = await Promise.all([getCurrent(coords.lat, coords.lon), getForecast(coords.lat, coords.lon)]);
      renderCurrent(cur);
      renderHourly(fc);
      renderDaily(fc);
      setLocationLabel(coords.label||'Position');
    }

    // ---------- GEO ----------
    const gpsBtn = $('#gpsBtn');
    gpsBtn.addEventListener('click', ()=>{
      if(!('geolocation' in navigator)) return alert('GPS non disponible.');
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude:lat, longitude:lon} = pos.coords;
        lastCoords = {lat,lon,label:'GPS'};
        load(lastCoords).catch(e=>alert('OpenWeatherMap: '+e.message));
      }, err=> alert('GPS refuse: ' + err.message));
    });

    $('#refreshBtn').addEventListener('click', ()=>{
      load(lastCoords).catch(e=>alert('OpenWeatherMap: '+e.message));
    });

    let lastCoords = DEFAULT_COORDS;

    // ---------- INIT ----------
    async function init(){
      if(!ensureKey()) return;
      try{
        await load(DEFAULT_COORDS);
      }catch(e){
        console.error(e);
        alert('OpenWeatherMap: ' + e.message);
      }
    }
    init();
  </script>
</body>
</html>

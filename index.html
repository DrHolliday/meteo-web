<script>
    // ---------- CONFIG ----------
    const DEFAULT_COORDS = { lat: 49.6116, lon: 6.1319, label: "Luxembourg" };
    const UNITS = "metric";
    const LANG = "fr"; 

    // ---------- UTILS ----------
    const $ = sel => document.querySelector(sel);
    const fmtTime = ts => new Date(ts * 1000).toLocaleTimeString(undefined, {hour: '2-digit', minute: '2-digit'});
    const fmtDay = ts => new Date(ts * 1000).toLocaleDateString(undefined, { weekday: 'short'});
    const fmtDate = ts => new Date(ts).toLocaleTimeString(undefined, {hour: '2-digit', minute: '2-digit'});
    const stripDiacritics = s => (s||"").normalize('NFD').replace(/[\u0300-\u036f]/g, '');
    function tempClass(t){
      if (t < 10) return 'temp-blue';
      if (t < 25) return 'temp-yellow';
      return 'temp-orange';
    }
    function kmh(ms){ return Math.round(ms * 3.6); }

    // ---------- THEME ----------
    const themeBtn = $('#themeBtn');
    function applyTheme(t){ document.body.setAttribute('data-theme', t); localStorage.setItem('theme', t); }
    themeBtn.addEventListener('click', ()=>{ const t = document.body.getAttribute('data-theme')==='dark'?'light':'dark'; applyTheme(t); });
    applyTheme(localStorage.getItem('theme')||'dark');

    // ---------- FETCH WEATHER ----------
    async function fetchWeather(lat, lon, apiKey){
      const url = new URL('https://api.openweathermap.org/data/3.0/onecall');
      url.searchParams.set('lat', lat);
      url.searchParams.set('lon', lon);
      url.searchParams.set('units', UNITS);
      url.searchParams.set('lang', LANG);
      url.searchParams.set('appid', apiKey);
      const r = await fetch(url);
      let body = null;
      try { body = await r.json(); } catch {}
      if(!r.ok){
        const msg = body?.message || (`HTTP ${r.status}`);
        throw new Error(msg);
      }
      return body;
    }

    function iconUrl(code){ return `https://openweathermap.org/img/wn/${code}@2x.png`; }

    // ---------- RENDER ----------
    function renderCurrent(data){
      const c = data.current;
      const t = Math.round(c.temp);
      const desc = stripDiacritics(c.weather?.[0]?.description || '--');
      $('#currentIcon').src = iconUrl(c.weather?.[0]?.icon || '01d');
      $('#currentTemp').textContent = t + '°C';
      $('#currentTemp').className = 'temp ' + tempClass(t);
      $('#currentDesc').textContent = desc;
      $('#feelsLike').textContent = 'Ressenti ' + Math.round(c.feels_like) + '°C';
      $('#wind').textContent = 'Vent ' + kmh(c.wind_speed) + ' km/h';
      $('#humidity').textContent = 'Humidite ' + c.humidity + '%';
      $('#uv').textContent = 'UV ' + Math.round(c.uvi);
      $('#updatedAt').textContent = 'Maj ' + fmtDate(Date.now());
    }

    function renderHourly(data){
      const wrap = $('#hourlyStrip');
      wrap.innerHTML = '';
      data.hourly.slice(0,12).forEach(h=>{
        const t = Math.round(h.temp);
        const el = document.createElement('div');
        el.className = 'hour';
        el.innerHTML = `
          <div class="muted">${fmtTime(h.dt)}</div>
          <img src="${iconUrl(h.weather?.[0]?.icon||'01d')}" alt="" width="48" height="48" />
          <div class="${tempClass(t)}" style="font-weight:700">${t}°C</div>
        `;
        wrap.appendChild(el);
      });
    }

    function renderDaily(data){
      const grid = $('#dailyGrid');
      grid.innerHTML = '';
      data.daily.slice(1,6).forEach(d=>{
        const tmin = Math.round(d.temp.min), tmax = Math.round(d.temp.max);
        const el = document.createElement('div');
        el.className = 'hour';
        el.innerHTML = `
          <div class="muted" style="text-transform:capitalize">${stripDiacritics(fmtDay(d.dt))}</div>
          <img src="${iconUrl(d.weather?.[0]?.icon||'01d')}" alt="" width="48" height="48" />
          <div style="display:flex;justify-content:center;gap:6px">
            <span class="${tempClass(tmax)}" style="font-weight:700">${tmax}°</span>
            <span class="muted">${tmin}°</span>
          </div>
        `;
        grid.appendChild(el);
      });
    }

    function setLocationLabel(name){ $('#locationLabel').textContent = name; }

    async function load(coords, apiKey){
      try{
        lastCoords = coords;
        setLocationLabel((coords.label||'Localisation') + ' • chargement...');
        const data = await fetchWeather(coords.lat, coords.lon, apiKey);
        renderCurrent(data); renderHourly(data); renderDaily(data);
        setLocationLabel((coords.label||'Position GPS'));
      }catch(e){
        console.error('OWM error:', e);
        alert('OpenWeatherMap: ' + e.message);
      }
    }

    // ---------- GEO ----------
    const gpsBtn = $('#gpsBtn');
    gpsBtn.addEventListener('click', ()=>{
      if(!('geolocation' in navigator)) return alert('GPS non disponible dans ce navigateur.');
      navigator.geolocation.getCurrentPosition(pos=>{
        const {latitude:lat, longitude:lon} = pos.coords;
        load({lat,lon,label:'GPS'}, apiKey);
      }, err=>{
        alert('GPS refuse: ' + err.message);
      });
    });

    $('#refreshBtn').addEventListener('click', ()=>{
      const label = $('#locationLabel').textContent.includes('GPS')?'GPS':DEFAULT_COORDS.label;
      load(label==='GPS'? { lat: lastCoords.lat, lon: lastCoords.lon, label: 'GPS' } : DEFAULT_COORDS, apiKey);
    });

    let lastCoords = DEFAULT_COORDS;
    let apiKey = null;

    async function init(){
      apiKey = localStorage.getItem('owm_api_key');
      if(!apiKey){
        apiKey = prompt("Entrez votre clé API OpenWeatherMap (One Call 3.0):");
        if(apiKey) localStorage.setItem('owm_api_key', apiKey);
      }
      if(!apiKey){
        $('#locationLabel').textContent = 'Clé API manquante.';
        return;
      }
      await load(DEFAULT_COORDS, apiKey);
    }
    init();
</script>

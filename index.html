<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Meteo personnelle</title>
  <style>
    :root{
      --bg:#0b0f14; --fg:#e6e8eb; --muted:#9aa4af; --card:#121821; --accent:#4ea1ff;
      --blue:#3b82f6; --yellow:#facc15; --orange:#fb923c;
      --shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    [data-theme="light"]{ --bg:#f6f7f9; --fg:#0e1116; --muted:#586173; --card:#ffffff; --accent:#0b74ff; --shadow: 0 8px 20px rgba(0,0,0,.08);}    
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui, Arial}
    .wrap{max-width:1100px;margin:0 auto;padding:24px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:18px}
    .title{font-size:22px;font-weight:700}
    .subtitle{font-size:13px;color:var(--muted)}
    .row{display:grid;grid-template-columns:1.5fr 1fr;gap:16px}
    @media (max-width:900px){.row{grid-template-columns:1fr}}
    .card{background:var(--card);border-radius:16px;padding:16px;box-shadow:var(--shadow);position:relative;overflow:hidden}
    .card.bg-img{background-size:cover;background-position:center;animation:zoomIn 5s ease forwards}
    .card.bg-img::before{content:"";position:absolute;inset:0;background:rgba(0,0,0,0.45);z-index:0}
    .card > *{position:relative;z-index:1}
    button{background:transparent;border:1px solid rgba(255,255,255,.18);color:var(--fg);padding:8px 12px;border-radius:12px;cursor:pointer}
    button:hover{border-color:var(--accent)}
    .grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    @media (max-width:700px){.grid{grid-template-columns:repeat(2,1fr)}}
    .current{display:grid;grid-template-columns:auto 1fr;gap:14px;align-items:center}
    .current .temp{font-size:48px;font-weight:800}
    .kpi{display:flex;gap:14px;flex-wrap:wrap;margin-top:6px}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.8);color:#222;font-size:13px}
    .scrollx{display:flex;gap:10px;overflow:auto;padding-bottom:6px}
    .hour{min-width:84px;padding:10px;border-radius:12px;border:1px solid rgba(255,255,255,.1);text-align:center}
    .muted{color:var(--muted)}
    .temp-blue{color:var(--blue)} .temp-yellow{color:var(--yellow)} .temp-orange{color:var(--orange)}
    .footer{margin-top:18px;font-size:12px;color:var(--muted)}

    @keyframes zoomIn {
      from {transform:scale(1);}
      to {transform:scale(1.1);}
    }
  </style>
</head>
<body data-theme="dark">
  <div class="wrap">
    <header>
      <div>
        <div class="title">Meteo personnelle</div>
        <div class="subtitle" id="locationLabel">Luxembourg • en cours de chargement...</div>
      </div>
      <div class="controls">
        <button id="themeBtn">Theme</button>
        <button id="apiBtn">Cle API</button>
        <button id="gpsBtn">GPS</button>
        <button id="refreshBtn">Refresh</button>
      </div>
    </header>

    <div class="row">
      <section class="card bg-img" id="currentCard">
        <div class="current">
          <img id="currentIcon" alt="icon" width="84" height="84" src="" />
          <div>
            <div class="temp" id="currentTemp">--°C</div>
            <div class="muted" id="currentDesc">--</div>
            <div class="kpi">
              <span class="pill" id="feelsLike">Ressenti --°C</span>
              <span class="pill" id="wind">Vent -- km/h</span>
              <span class="pill" id="humidity">Humidite --%</span>
              <span class="pill" id="uv">UV --</span>
            </div>
          </div>
        </div>
        <div class="footer" id="updatedAt">Maj --:--</div>
      </section>

      <section class="card">
        <h3>Previsions 5 jours</h3>
        <div class="grid" id="dailyGrid"></div>
      </section>
    </div>

    <section class="card" style="margin-top:16px">
      <h3>Heure par heure (prochaines 12h)</h3>
      <div class="scrollx" id="hourlyStrip"></div>
    </section>

    <div class="footer">Donnees: OpenWeatherMap • icones OWM. Images: Unsplash</div>
  </div>

  <script>
    const bgImages = {
      '01d': 'https://images.unsplash.com/photo-1506744038136-46273834b3fb',
      '01n': 'https://images.unsplash.com/photo-1500530855697-b586d89ba3ee',
      '02d': 'https://images.unsplash.com/photo-1504384308090-c894fdcc538d',
      '02n': 'https://images.unsplash.com/photo-1503264116251-35a269479413',
      '03d': 'https://images.unsplash.com/photo-1499346030926-9a72daac6c63',
      '03n': 'https://images.unsplash.com/photo-1499346030926-9a72daac6c63',
      '04d': 'https://images.unsplash.com/photo-1499346030926-9a72daac6c63',
      '04n': 'https://images.unsplash.com/photo-1499346030926-9a72daac6c63',
      '09d': 'https://images.unsplash.com/photo-1501594907352-04cda38ebc29',
      '09n': 'https://images.unsplash.com/photo-1501594907352-04cda38ebc29',
      '10d': 'https://images.unsplash.com/photo-1501594907352-04cda38ebc29',
      '10n': 'https://images.unsplash.com/photo-1501594907352-04cda38ebc29',
      '11d': 'https://images.unsplash.com/photo-1501594907352-04cda38ebc29',
      '11n': 'https://images.unsplash.com/photo-1501594907352-04cda38ebc29',
      '13d': 'https://images.unsplash.com/photo-1608889177305-94589f5f6b4e',
      '13n': 'https://images.unsplash.com/photo-1608889177305-94589f5f6b4e',
      '50d': 'https://images.unsplash.com/photo-1502082553048-f009c37129b9',
      '50n': 'https://images.unsplash.com/photo-1502082553048-f009c37129b9'
    };
    const DEFAULT_COORDS = { lat: 49.6116, lon: 6.1319, label: "Luxembourg" };
    const UNITS = "metric", LANG = "fr";
    const $ = sel => document.querySelector(sel);
    const fmtTime = ts => new Date(ts).toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
    const fmtDayShort = ts => new Date(ts).toLocaleDateString(undefined,{weekday:'short'});
    const fmtDate = ts => new Date(ts).toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});
    const stripDiacritics = s => (s||"").normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    function tempClass(t){if(t<10)return'temp-blue';if(t<25)return'temp-yellow';return'temp-orange'}
    function kmh(ms){return Math.round(ms*3.6)}
    const themeBtn=$('#themeBtn');function applyTheme(t){document.body.setAttribute('data-theme',t);localStorage.setItem('theme',t);}themeBtn.addEventListener('click',()=>{const t=document.body.getAttribute('data-theme')==='dark'?'light':'dark';applyTheme(t);});applyTheme(localStorage.getItem('theme')||'dark');
    let apiKey=null;function requireApiKey(){apiKey=localStorage.getItem('owm_api_key');if(!apiKey){apiKey=prompt('Entrez votre cle API:');if(apiKey)localStorage.setItem('owm_api_key',apiKey.trim());}return!!localStorage.getItem('owm_api_key');}
    $('#apiBtn').addEventListener('click',()=>{const current=localStorage.getItem('owm_api_key')||'';const entered=prompt('Cle API actuelle:',current);if(entered!==null){const v=entered.trim();if(v){localStorage.setItem('owm_api_key',v);alert('Cle API enregistree.');load(DEFAULT_COORDS);}else{localStorage.removeItem('owm_api_key');alert('Cle supprimee.');$('#locationLabel').textContent='Cle API manquante.';}}});
    async function fetchCurrent(lat,lon){const key=localStorage.getItem('owm_api_key');if(!key)throw new Error('Cle API absente.');const url=new URL('https://api.openweathermap.org/data/2.5/weather');url.searchParams.set('lat',lat);url.searchParams.set('lon',lon);url.searchParams.set('units',UNITS);url.searchParams.set('lang',LANG);url.searchParams.set('appid',key);const r=await fetch(url);let body=null;try{body=await r.json();}catch{}if(!r.ok)throw new Error(body?.message||('HTTP '+r.status));return body;}
    async function fetchForecast(lat,lon){const key=localStorage.getItem('owm_api_key');if(!key)throw new Error('Cle API absente.');const url=new URL('https://api.openweathermap.org/data/2.5/forecast');url.searchParams.set('lat',lat);url.searchParams.set('lon',lon);url.searchParams.set('units',UNITS);url.searchParams.set('lang',LANG);url.searchParams.set('appid',key);const r=await fetch(url);let body=null;try{body=await r.json();}catch{}if(!r.ok)throw new Error(body?.message||('HTTP '+r.status));return body;}
    function aggregateDaily(list){const byDay=new Map();list.forEach(item=>{const d=new Date(item.dt*1000);d.setHours(0,0,0,0);const key=d.getTime();if(!byDay.has(key))byDay.set(key,[]);byDay.get(key).push(item);});const days=Array.from(byDay.keys()).sort((a,b)=>a-b).slice(0,6);return days.map(key=>{const arr=byDay.get(key);const temps=arr.map(x=>x.main.temp);const min=Math.round(Math.min(...temps)),max=Math.round(Math.max(...temps));let pick=arr.reduce((best,x)=>{const hour=new Date(x.dt*1000).getHours();const score=Math.abs(12-hour);return(score<best.score)?{score,item:x}:best;},{score:99,item:arr[0]}).item;const icon=pick.weather?.[0]?.icon||'01d';return{dayTs:key,min,max,icon};});}
    function renderCurrentFromOWM(current){const t=Math.round(current.main.temp);const desc=stripDiacritics(current.weather?.[0]?.description||'--');const icon=current.weather?.[0]?.icon||'01d';$('#currentIcon').src=`https://openweathermap.org/img/wn/${icon}@2x.png`;$('#currentTemp').textContent=t+'°C';$('#currentTemp').className='temp '+tempClass(t);$('#currentDesc').textContent=desc;$('#feelsLike').textContent='Ressenti '+Math.round(current.main.feels_like||current.main.temp)+'°C';$('#wind').textContent='Vent '+kmh(current.wind?.speed||0)+' km/h';$('#humidity').textContent='Humidite '+(current.main.humidity??'--')+'%';$('#uv').textContent='UV --';$('#updatedAt').textContent='Maj '+fmtDate(Date.now());if(bgImages[icon]){$('#currentCard').style.backgroundImage=`url(${bgImages[icon]}?auto=format&fit=crop&w=1200&q=80)`;}}
    function renderHourlyFromForecast(list){const wrap=$('#hourlyStrip');wrap.innerHTML='';list.slice(0,4).forEach(h=>{const t=Math.round(h.main.temp);const el=document.createElement('div');el.className='hour';el.innerHTML=`<div class="muted">${fmtTime(h.dt*1000)}</div><img src="https://openweathermap.org/img/wn/${h.weather?.[0]?.icon||'01d'}@2x.png" width="48" height="48"/><div class="${tempClass(t)}" style="font-weight:700">${t}°C</div>`;wrap.appendChild(el);});}
    function renderDailyFromForecast(list){const days=aggregateDaily(list).slice(1,6);const grid=$('#dailyGrid');grid.innerHTML='';days.forEach(d=>{const el=document.createElement('div');el.className='hour';el.innerHTML=`<div class="muted">${stripDiacritics(fmtDayShort(d.dayTs))}</div><img src="https://openweathermap.org/img/wn/${d.icon}@2x.png" width="48" height="48"/><div style="display:flex;gap:6px;justify-content:center"><span class="${tempClass(d.max)}" style="font-weight:700">${d.max}°</span><span class="muted">${d.min}°</span></div>`;grid.appendChild(el);});}
    function setLocationLabel(name){$('#locationLabel').textContent=name;}
    let lastCoords=DEFAULT_COORDS;async function load(coords){try{if(!requireApiKey()){setLocationLabel('Cle API manquante.');return;}lastCoords=coords;setLocationLabel((coords.label||'Localisation')+' • chargement...');const [cur,fcast]=await Promise.all([fetchCurrent(coords.lat,coords.lon),fetchForecast(coords.lat,coords.lon)]);renderCurrentFromOWM(cur);renderHourlyFromForecast(fcast.list);renderDailyFromForecast(fcast.list);setLocationLabel(coords.label||'Position GPS');}catch(e){alert('OpenWeatherMap: '+e.message);}}
    $('#gpsBtn').addEventListener('click',()=>{if(!('geolocation'in navigator))return alert('GPS non dispo');navigator.geolocation.getCurrentPosition(pos=>{load({lat:pos.coords.latitude,lon:pos.coords.longitude,label:'GPS'});},err=>{alert('GPS refuse: '+err.message);});});
    $('#refreshBtn').addEventListener('click',()=>{const label=$('#locationLabel').textContent.includes('GPS')?'GPS':DEFAULT_COORDS.label;load(label==='GPS'?{lat:lastCoords.lat,lon:lastCoords.lon,label:'GPS'}:DEFAULT_COORDS);});
    (async function init(){if(!requireApiKey()){setLocationLabel('Cle API manquante.');return;}await load(DEFAULT_COORDS);})();
  </script>
</body>
</html>
